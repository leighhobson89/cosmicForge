<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cosmic Forge Analytics (Persistent)</title>
    <link rel="stylesheet" href="/tools/analytics-dashboard/styles.css" />
  </head>
  <body data-theme="terminal">
    <header>
      <h1>Cosmic Forge - Analytics Dashboard (Persistent)</h1>
      <div class="controls">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="terminal" selected>Terminal</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="frosty">Frosty</option>
          <option value="summer">Summer</option>
          <option value="forest">Forest</option>
        </select>
        <button id="btnRefresh">Refresh</button>
        <button id="btnReset">Reset local totals</button>
        <button id="btnExport">Export JSON</button>
        <button id="btnImport">Import JSON</button>
        <span id="status" class="muted"></span>
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Summary (All-time Local Rollup)</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Events</div><div class="value" id="kpiEvents">-</div></div>
          <div class="kpi"><div class="label">Unique Sessions</div><div class="value" id="kpiSessions">-</div></div>
          <div class="kpi"><div class="label">Unique Clients</div><div class="value" id="kpiClients">-</div></div>
          <div class="kpi"><div class="label">Black Hole Discovered (Clients)</div><div class="value" id="kpiBlackHoleDiscovered">-</div></div>
          <div class="kpi"><div class="label">Black Hole Researched (Unique Clients)</div><div class="value" id="kpiBlackHoleResearched">-</div></div>
          <div class="kpi"><div class="label">Legendary Asteroids (Total)</div><div class="value" id="kpiLegendaryAsteroidsTotal">-</div></div>
          <div class="kpi"><div class="label">Legendary Asteroids (Unique Clients)</div><div class="value" id="kpiLegendaryAsteroidsUnique">-</div></div>
        </div>
        <div style="margin-top:14px">
          <h2>Pioneer Playtime (All-time Active)</h2>
          <table>
            <thead><tr><th>Pioneer</th><th>Total Active Time</th></tr></thead>
            <tbody id="pioneerPlaytime"></tbody>
          </table>
        </div>
        <div style="margin-top:10px" class="muted">
          <span class="mono" id="meta"></span>
        </div>
      </div>

      <div class="grid">
        <div class="card span-6">
          <h2>Miaplacidus &amp; Megastructures</h2>
          <table>
            <thead><tr><th>Milestone</th><th>Count</th></tr></thead>
            <tbody id="miaplacidusMegastructures"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Views (ui_view)</h2>
          <table>
            <thead><tr><th>View</th><th>Count</th></tr></thead>
            <tbody id="topViews"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Time Spent (ui_view_duration)</h2>
          <table>
            <thead><tr><th>View</th><th>Total Time</th></tr></thead>
            <tbody id="topDurations"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Achievements (achievement_granted)</h2>
          <table>
            <thead><tr><th>Achievement</th><th>Count</th></tr></thead>
            <tbody id="topAchievements"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Feedback</h2>
          <table>
            <thead><tr><th>Metric</th><th>Count</th></tr></thead>
            <tbody id="feedback"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Feedback Comments</h2>
          <div id="feedbackComments" class="mono" style="white-space: pre-wrap; max-height: 260px; overflow: auto;"></div>
        </div>

        <div class="card span-12">
          <h2>Star System Activity</h2>
          <table>
            <thead><tr><th>Star System</th><th>Count</th></tr></thead>
            <tbody id="starSystems"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Theme Selections (Total)</h2>
          <table>
            <thead><tr><th>Theme</th><th>Selections</th></tr></thead>
            <tbody id="themeSelections"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Onboarding</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="onboarding"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Rocket Parts Built</h2>
          <table>
            <thead><tr><th>Rocket</th><th>Parts Built</th></tr></thead>
            <tbody id="rocketPartsBuilt"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Space Actions</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="spaceActions"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Diplomacy Choices</h2>
          <table>
            <thead><tr><th>Choice</th><th>Count</th></tr></thead>
            <tbody id="diplomacyChoices"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Settings Usage (Unique Clients from Snapshots)</h2>
          <table>
            <thead><tr><th>Setting:State</th><th>Clients</th></tr></thead>
            <tbody id="settingsUsage"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Triggered Events</h2>
          <table>
            <thead><tr><th>Event</th><th>Triggered</th></tr></thead>
            <tbody id="triggeredEvents"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Philosophy Picks (Unique Clients)</h2>
          <table>
            <thead><tr><th>Philosophy</th><th>Clients</th></tr></thead>
            <tbody id="philosophyPicks"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Best Selling Ascendency Perks</h2>
          <table>
            <thead><tr><th>Perk</th><th>Purchases</th></tr></thead>
            <tbody id="ascendencyPerks"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Most Researched Philosophy Repeatables</h2>
          <table>
            <thead><tr><th>Philosophy:Tech</th><th>Research Count</th></tr></thead>
            <tbody id="philosophyRepeatables"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>JS Errors</h2>
          <div class="controls" style="margin-bottom: 10px; gap: 14px;">
            <label><input type="checkbox" id="filterRuntime" checked /> Runtime</label>
            <label><input type="checkbox" id="filterRejections" checked /> Rejections</label>
            <label><input type="checkbox" id="filterWithStack" checked /> Only with stack</label>
            <label><input type="checkbox" id="filterOnlyLocal" /> Only local scripts</label>
          </div>
          <table>
            <thead><tr><th>Count</th><th>Last Seen</th><th>Type</th><th>Message</th><th>Location</th><th></th></tr></thead>
            <tbody id="jsErrors"></tbody>
          </table>
          <div id="jsErrorDetails" class="mono" style="white-space: pre-wrap; margin-top: 10px; max-height: 320px; overflow: auto;"></div>
        </div>
      </div>
    </main>

    <input id="fileImport" type="file" accept="application/json" style="display:none" />

    <script type="module">
      const $ = (id) => document.getElementById(id);

      const THEME_STORAGE_KEY = 'analytics_dashboard_theme';

      function safeParse(value, fallback) {
        try {
          return JSON.parse(value);
        } catch {
          return fallback;
        }
      }

      function isLocalScript(filename) {
        if (!filename) return false;
        const s = String(filename);
        if (s.startsWith('/')) return true;
        if (!s.includes('://')) return true;
        if (window.location && typeof window.location.origin === 'string') {
          return s.startsWith(window.location.origin);
        }
        return false;
      }

      function renderJsErrors(rollup) {
        const tbody = $('jsErrors');
        if (!tbody) return;

        const showRuntime = $('filterRuntime') ? $('filterRuntime').checked : true;
        const showRejections = $('filterRejections') ? $('filterRejections').checked : true;
        const onlyWithStack = $('filterWithStack') ? $('filterWithStack').checked : false;
        const onlyLocal = $('filterOnlyLocal') ? $('filterOnlyLocal').checked : false;

        const entries = Object.entries(rollup.jsErrorSignatures || {}).map(([signature, rec]) => ({ signature, ...rec }));

        const filtered = entries.filter((rec) => {
          const sample = rec.sample || {};
          const eventName = sample.event_name || '';
          if (!showRuntime && eventName === 'js_error') return false;
          if (!showRejections && eventName === 'unhandled_promise_rejection') return false;
          if (onlyWithStack && !(typeof sample.stack === 'string' && sample.stack.trim().length > 0)) return false;
          if (onlyLocal && !isLocalScript(sample.filename)) return false;
          return true;
        });

        filtered.sort((a, b) => (b.count || 0) - (a.count || 0));

        tbody.innerHTML = '';
        for (const rec of filtered.slice(0, 500)) {
          const sample = rec.sample || {};
          const tr = document.createElement('tr');

          const tdCount = document.createElement('td');
          tdCount.textContent = fmtInt(rec.count || 0);
          tdCount.className = 'mono';

          const tdLast = document.createElement('td');
          tdLast.textContent = rec.lastSeen || '-';
          tdLast.className = 'mono';

          const tdType = document.createElement('td');
          tdType.textContent = sample.event_name || '-';
          tdType.className = 'mono';

          const tdMsg = document.createElement('td');
          tdMsg.textContent = sample.message || '(no message)';
          tdMsg.className = 'mono';

          const tdLoc = document.createElement('td');
          const loc = `${sample.filename || '-'}:${sample.lineno ?? '-'}:${sample.colno ?? '-'}`;
          tdLoc.textContent = loc;
          tdLoc.className = 'mono';

          const tdBtn = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = 'View';
          btn.addEventListener('click', () => {
            const details = [
              `event=${sample.event_name || ''}`,
              `count=${rec.count || 0}`,
              `lastSeen=${rec.lastSeen || ''}`,
              `name=${sample.name || ''}`,
              `message=${sample.message || ''}`,
              `file=${sample.filename || ''}`,
              `line=${sample.lineno ?? ''}`,
              `col=${sample.colno ?? ''}`,
              `path=${sample.path || ''}`,
              '',
              'stack:',
              sample.stack || '(no stack)'
            ].join('\n');
            $('jsErrorDetails').textContent = details;
          });
          tdBtn.appendChild(btn);

          tr.appendChild(tdCount);
          tr.appendChild(tdLast);
          tr.appendChild(tdType);
          tr.appendChild(tdMsg);
          tr.appendChild(tdLoc);
          tr.appendChild(tdBtn);
          tbody.appendChild(tr);
        }

        if (filtered.length === 0) {
          $('jsErrorDetails').textContent = '(no errors match filters)';
        }
      }

      function nowIso() {
        return new Date().toISOString();
      }

      function fmtInt(n) {
        return typeof n === 'number' && Number.isFinite(n) ? n.toLocaleString() : '-';
      }

      function fmtDuration(ms) {
        if (typeof ms !== 'number' || !Number.isFinite(ms)) return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const s = totalSeconds % 60;
        const totalMinutes = Math.floor(totalSeconds / 60);
        const m = totalMinutes % 60;
        const h = Math.floor(totalMinutes / 60);
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }

      function newRollup() {
        return {
          version: 1,
          createdAt: nowIso(),
          updatedAt: nowIso(),
          cursorAfterIso: null,
          cursorTailKeys: {},

          // Keep event ids to render triggered events with 0s.
          knownRandomEventIds: [],
          knownAchievementIds: [],

          // Feedback
          feedbackThumbUp: 0,
          feedbackThumbDown: 0,
          feedbackAccepted: 0,
          feedbackRefused: 0,
          feedbackComments: [],

          jsErrorSignatures: {},

          // Sets
          uniqueSessions: {},
          uniqueClients: {},
          pioneersSeen: {},

          // Unique sets
          blackHoleDiscoveredClients: {},
          blackHoleResearchedClients: {},
          legendaryAsteroidClients: {},

          // Totals
          totalEvents: 0,

          // KPI totals
          miaplacidusReached: 0,
          miaplacidusForcefieldDown: 0,
          miaplacidusSettled: 0,
          legendaryAsteroidDiscoveries: 0,

          // Megastructures
          megastructureCapturedCounts: {},

          // Playtime
          pioneerPlaytimeMs: {},

          // View/click/achievement breakdown
          viewCounts: {},
          viewDurationMs: {},
          clickCounts: {},
          achievementCounts: {},
          starSystemSeenCounts: {},

          // Theme + onboarding
          themeSelectionCounts: {},
          onboardingPromptYes: 0,
          onboardingPromptNo: 0,
          onboardingExit: 0,

          // Rocket parts built
          rocketPartBuildCounts: {},

          // Counts
          starshipLaunched: 0,
          settleSystem: 0,
          diplomacyChoiceCounts: {},
          triggeredEventCounts: {},

          philosophyPickClientsById: {},
          ascendencyPerkPurchaseCounts: {},
          philosophyRepeatableCounts: {},

          // Settings unique clients snapshot
          settingsSnapshotClientsByKeyValue: {},
        };
      }

      function applyTheme(theme) {
        if (!theme) return;
        document.body.setAttribute('data-theme', theme);
        try {
          localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch {
          // ignore
        }
      }

      function loadSavedTheme() {
        let saved = null;
        try {
          saved = localStorage.getItem(THEME_STORAGE_KEY);
        } catch {
          saved = null;
        }
        const theme = saved || 'terminal';
        const sel = $('theme');
        if (sel) sel.value = theme;
        applyTheme(theme);
      }

      async function loadRollup() {
        try {
          const res = await fetch('/api/persistent-rollup');
          const json = await res.json();
          if (!res.ok) throw new Error(json?.error || 'Failed to load rollup');
          const parsed = json?.rollup;
          if (!parsed || typeof parsed !== 'object') return newRollup();
          return { ...newRollup(), ...parsed };
        } catch {
          return newRollup();
        }
      }

      async function saveRollup(rollup) {
        rollup.updatedAt = nowIso();
        try {
          const res = await fetch('/api/persistent-rollup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rollup }),
          });
          if (!res.ok) {
            const json = await res.json().catch(() => ({}));
            throw new Error(json?.error || 'Failed to save rollup');
          }
        } catch {
          // ignore
        }
      }

      function addToSetObject(setObj, key) {
        if (!key) return;
        setObj[key] = true;
      }

      function inc(mapObj, key, amount = 1) {
        if (!key) return;
        mapObj[key] = (mapObj[key] || 0) + amount;
      }

      function normKey(value, fallback = null) {
        const s = String(value ?? '').trim();
        return s.length ? s : fallback;
      }

      function eventKey(e) {
        const payload = e.payload && typeof e.payload === 'object' ? e.payload : {};
        return `${e.event_time || ''}|${e.event_name || ''}|${e.client_id || ''}|${e.session_id || ''}|${e.pioneer_name || ''}|${JSON.stringify(payload)}`;
      }

      function applyEvent(rollup, e) {
        rollup.totalEvents += 1;

        if (e.session_id) addToSetObject(rollup.uniqueSessions, e.session_id);
        if (e.client_id) addToSetObject(rollup.uniqueClients, e.client_id);
        if (e.pioneer_name) addToSetObject(rollup.pioneersSeen, e.pioneer_name);

        const payload = e.payload && typeof e.payload === 'object' ? e.payload : {};

        if (e.event_name === 'ui_view') {
          const viewId = normKey(payload.view_id, 'unknown');
          inc(rollup.viewCounts, viewId, 1);
        }

        if (e.event_name === 'ui_view_duration') {
          const ms = typeof payload.duration_ms === 'number' ? payload.duration_ms : 0;
          const pioneer = normKey(e.pioneer_name, null);
          if (pioneer) {
            rollup.pioneerPlaytimeMs[pioneer] = (rollup.pioneerPlaytimeMs[pioneer] || 0) + Math.max(0, ms);
          }

          const viewId = normKey(payload.view_id, 'unknown');
          rollup.viewDurationMs[viewId] = (rollup.viewDurationMs[viewId] || 0) + Math.max(0, ms);
        }

        if (e.event_name === 'dom_click') {
          const id = payload.id ? `#${payload.id}` : '(no id)';
          const tag = payload.tag ? String(payload.tag).toUpperCase() : '(no tag)';
          const key = `${tag} ${id}`;
          inc(rollup.clickCounts, key, 1);
        }

        if (e.event_name === 'achievement_granted') {
          const id = normKey(payload.achievement_id, 'unknown');
          inc(rollup.achievementCounts, id, 1);
        }

        if (e.event_name === 'feedback_thumb_up') {
          rollup.feedbackThumbUp = (rollup.feedbackThumbUp || 0) + 1;
        }

        if (e.event_name === 'feedback_thumb_down') {
          rollup.feedbackThumbDown = (rollup.feedbackThumbDown || 0) + 1;
        }

        if (e.event_name === 'feedback_response') {
          if (payload.action === 'accepted') rollup.feedbackAccepted = (rollup.feedbackAccepted || 0) + 1;
          if (payload.action === 'refused') rollup.feedbackRefused = (rollup.feedbackRefused || 0) + 1;

          const comment = typeof payload.comment === 'string' ? payload.comment.trim() : '';
          if (comment.length > 0) {
            if (!Array.isArray(rollup.feedbackComments)) rollup.feedbackComments = [];
            rollup.feedbackComments.push(comment);
          }
        }

        if (e.event_name === 'js_error' || e.event_name === 'unhandled_promise_rejection') {
          const message = normKey(payload.message, '(no message)');
          const filename = normKey(payload.filename, null);
          const lineno = Number.isFinite(payload.lineno) ? payload.lineno : null;
          const colno = Number.isFinite(payload.colno) ? payload.colno : null;
          const signature = `${e.event_name}|${message}|${filename || ''}|${lineno || ''}|${colno || ''}`;

          const mapObj = rollup.jsErrorSignatures || (rollup.jsErrorSignatures = {});
          if (!mapObj[signature]) {
            if (Object.keys(mapObj).length >= 500) return;
            mapObj[signature] = {
              count: 0,
              lastSeen: null,
              sample: null
            };
          }

          mapObj[signature].count = (mapObj[signature].count || 0) + 1;
          mapObj[signature].lastSeen = e.event_time || mapObj[signature].lastSeen;
          if (!mapObj[signature].sample) {
            mapObj[signature].sample = {
              event_name: e.event_name,
              message,
              name: payload.name ?? null,
              filename,
              lineno,
              colno,
              stack: typeof payload.stack === 'string' ? payload.stack : null,
              path: payload.path ?? null
            };
          }
        }

        if (e.event_name === 'star_system_seen') {
          const sys = normKey(payload.star_system, 'unknown');
          inc(rollup.starSystemSeenCounts, sys, 1);
        }

        if (e.event_name === 'milestone_reached') {
          if (payload.milestone_id === 'reached_star_miaplacidus') {
            rollup.miaplacidusReached += 1;
          }
        }

        if (e.event_name === 'megastructure_captured') {
          const id = Number(payload.megastructure_id);
          if (Number.isFinite(id) && id >= 1 && id <= 4) {
            inc(rollup.megastructureCapturedCounts, String(id), 1);
          }
        }

        if (e.event_name === 'miaplacidus_forcefield_down') {
          rollup.miaplacidusForcefieldDown += 1;
        }

        if (e.event_name === 'miaplacidus_settled') {
          rollup.miaplacidusSettled += 1;
        }

        if (e.event_name === 'black_hole_discovered') {
          if (e.client_id) addToSetObject(rollup.blackHoleDiscoveredClients, e.client_id);
        }

        if (e.event_name === 'black_hole_research_completed') {
          if (e.client_id) addToSetObject(rollup.blackHoleResearchedClients, e.client_id);
        }

        if (e.event_name === 'legendary_asteroid_discovered') {
          rollup.legendaryAsteroidDiscoveries += 1;
          if (e.client_id) addToSetObject(rollup.legendaryAsteroidClients, e.client_id);
        }

        if (e.event_name === 'theme_selected') {
          const themeId = normKey(payload.theme_id, 'unknown');
          inc(rollup.themeSelectionCounts, themeId, 1);
        }

        if (e.event_name === 'onboarding_prompt_yes') {
          rollup.onboardingPromptYes += 1;
        }

        if (e.event_name === 'onboarding_prompt_no') {
          rollup.onboardingPromptNo += 1;
        }

        if (e.event_name === 'onboarding_exit') {
          rollup.onboardingExit += 1;
        }

        if (e.event_name === 'rocket_part_built') {
          const rocketId = normKey(payload.rocket_id, 'unknown');
          inc(rollup.rocketPartBuildCounts, rocketId, 1);
        }

        if (e.event_name === 'philosophy_selected') {
          const philosophyId = normKey(payload.philosophy_id, 'unknown');
          if (!rollup.philosophyPickClientsById[philosophyId]) {
            rollup.philosophyPickClientsById[philosophyId] = {};
          }
          if (e.client_id) {
            rollup.philosophyPickClientsById[philosophyId][e.client_id] = true;
          }
        }

        if (e.event_name === 'ascendency_perk_purchased') {
          const perkId = normKey(payload.perk_id, 'unknown');
          inc(rollup.ascendencyPerkPurchaseCounts, perkId, 1);
        }

        if (e.event_name === 'philosophy_repeatable_researched') {
          const philosophyId = normKey(payload.philosophy_id, 'unknown');
          const techId = normKey(payload.tech_id, 'unknown');
          const k = `${philosophyId}:${techId}`;
          inc(rollup.philosophyRepeatableCounts, k, 1);
        }

        if (e.event_name === 'starship_launched') {
          rollup.starshipLaunched += 1;
        }

        if (e.event_name === 'settle_system') {
          rollup.settleSystem += 1;
        }

        if (e.event_name === 'diplomacy_choice') {
          const choice = normKey(payload.choice, 'unknown');
          inc(rollup.diplomacyChoiceCounts, choice, 1);
        }

        if (e.event_name === 'random_event_triggered') {
          const eventId = normKey(payload.event_id, 'unknown');
          inc(rollup.triggeredEventCounts, eventId, 1);
        }

        if (e.event_name === 'settings_snapshot') {
          const pairs = [
            ['background_audio', !!payload.background_audio],
            ['sfx', !!payload.sfx],
            ['custom_pointer', !!payload.custom_pointer],
            ['mouse_trail', !!payload.mouse_trail],
          ];

          for (const [settingId, enabled] of pairs) {
            const k = `${settingId}:${enabled ? 'on' : 'off'}`;
            if (!rollup.settingsSnapshotClientsByKeyValue[k]) {
              rollup.settingsSnapshotClientsByKeyValue[k] = {};
            }
            if (e.client_id) {
              rollup.settingsSnapshotClientsByKeyValue[k][e.client_id] = true;
            }
          }
        }
      }

      function renderRows(tbodyId, rows, formatValue) {
        const tbody = $(tbodyId);
        tbody.innerHTML = '';
        for (const row of rows) {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          const td2 = document.createElement('td');
          td1.textContent = row.key;
          td1.className = 'mono';
          td2.textContent = formatValue(row.value);
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        }
      }

      function render(rollup) {
        const sessions = Object.keys(rollup.uniqueSessions || {}).length;
        const clients = Object.keys(rollup.uniqueClients || {}).length;

        $('kpiEvents').textContent = fmtInt(rollup.totalEvents);
        $('kpiSessions').textContent = fmtInt(sessions);
        $('kpiClients').textContent = fmtInt(clients);
        $('kpiBlackHoleDiscovered').textContent = fmtInt(Object.keys(rollup.blackHoleDiscoveredClients || {}).length);
        $('kpiBlackHoleResearched').textContent = fmtInt(Object.keys(rollup.blackHoleResearchedClients || {}).length);
        $('kpiLegendaryAsteroidsTotal').textContent = fmtInt(rollup.legendaryAsteroidDiscoveries || 0);
        $('kpiLegendaryAsteroidsUnique').textContent = fmtInt(Object.keys(rollup.legendaryAsteroidClients || {}).length);

        $('meta').textContent = `cursorAfter=${rollup.cursorAfterIso ?? '-'} updatedAt=${rollup.updatedAt}`;

        const playtimeRows = Object.entries(rollup.pioneerPlaytimeMs || {})
          .map(([key, value]) => ({ key, value }))
          .sort((a, b) => b.value - a.value)
          .slice(0, 500);
        renderRows('pioneerPlaytime', playtimeRows, fmtDuration);

        const toRows = (obj, limit = 500) => {
          const rows = Object.entries(obj || {}).map(([key, value]) => ({ key, value }));
          rows.sort((a, b) => b.value - a.value);
          return rows.slice(0, limit);
        };

        renderRows('topViews', toRows(rollup.viewCounts, 30), fmtInt);
        renderRows('topDurations', toRows(rollup.viewDurationMs, 30), fmtDuration);
        const achievementIds = Array.isArray(rollup.knownAchievementIds) ? rollup.knownAchievementIds : [];
        const achievementRows = achievementIds.length
          ? achievementIds
            .map((id) => ({ key: id, value: rollup.achievementCounts?.[id] || 0 }))
            .sort((a, b) => (b.value - a.value) || a.key.localeCompare(b.key))
          : toRows(rollup.achievementCounts, 200);
        renderRows('topAchievements', achievementRows, fmtInt);
        renderRows('starSystems', toRows(rollup.starSystemSeenCounts, 30), fmtInt);
        renderRows('themeSelections', toRows(rollup.themeSelectionCounts, 50), fmtInt);

        const capture1 = (rollup.megastructureCapturedCounts || {})['1'] || 0;
        const capture2 = (rollup.megastructureCapturedCounts || {})['2'] || 0;
        const capture3 = (rollup.megastructureCapturedCounts || {})['3'] || 0;
        const capture4 = (rollup.megastructureCapturedCounts || {})['4'] || 0;
        renderRows('miaplacidusMegastructures', [
          { key: 'Megastructure 1 captured', value: capture1 },
          { key: 'Megastructure 2 captured', value: capture2 },
          { key: 'Megastructure 3 captured', value: capture3 },
          { key: 'Megastructure 4 captured', value: capture4 },
          { key: 'Miaplacidus force field down', value: rollup.miaplacidusForcefieldDown || 0 },
          { key: 'Miaplacidus settled (win cinematic)', value: rollup.miaplacidusSettled || 0 },
        ], fmtInt);

        renderRows('onboarding', [
          { key: 'Enter onboarding (YES)', value: rollup.onboardingPromptYes || 0 },
          { key: 'Decline onboarding (NO)', value: rollup.onboardingPromptNo || 0 },
          { key: 'Exit onboarding', value: rollup.onboardingExit || 0 },
        ], fmtInt);

        renderRows('rocketPartsBuilt', toRows(rollup.rocketPartBuildCounts, 10), fmtInt);

        renderRows('spaceActions', [
          { key: 'Starship launched', value: rollup.starshipLaunched || 0 },
          { key: 'Settle system', value: rollup.settleSystem || 0 },
        ], fmtInt);

        const diplomacyRows = ['bully', 'passive', 'harmony', 'vassalize', 'conquest'].map((c) => ({
          key: c,
          value: rollup.diplomacyChoiceCounts?.[c] || 0,
        }));
        renderRows('diplomacyChoices', diplomacyRows, fmtInt);

        const settingsKeys = [
          'background_audio:on',
          'background_audio:off',
          'sfx:on',
          'sfx:off',
          'custom_pointer:on',
          'custom_pointer:off',
          'mouse_trail:on',
          'mouse_trail:off',
        ];
        const settingsRows = settingsKeys.map((k) => ({
          key: k,
          value: rollup.settingsSnapshotClientsByKeyValue?.[k] ? Object.keys(rollup.settingsSnapshotClientsByKeyValue[k]).length : 0,
        }));
        renderRows('settingsUsage', settingsRows, fmtInt);

        const triggeredIds = Array.isArray(rollup.knownRandomEventIds)
          ? rollup.knownRandomEventIds.filter((id) => id !== 'modalReplacements')
          : [];
        const triggeredRows = triggeredIds.length
          ? triggeredIds.map((id) => ({ key: id, value: rollup.triggeredEventCounts?.[id] || 0 }))
          : toRows(rollup.triggeredEventCounts, 50);
        renderRows('triggeredEvents', triggeredRows, fmtInt);

        renderRows('feedback', [
          { key: 'Thumbs up', value: rollup.feedbackThumbUp || 0 },
          { key: 'Thumbs down', value: rollup.feedbackThumbDown || 0 },
          { key: 'Accepted (SEND FEEDBACK)', value: rollup.feedbackAccepted || 0 },
          { key: 'Refused (NO THANKS)', value: rollup.feedbackRefused || 0 },
        ], fmtInt);

        const comments = Array.isArray(rollup.feedbackComments) ? rollup.feedbackComments : [];
        $('feedbackComments').textContent = comments.length
          ? comments.map((c, i) => `${i + 1}. ${c}`).join('\n\n')
          : '(no comments)';

        const philosophyPicksRows = Object.entries(rollup.philosophyPickClientsById || {})
          .map(([k, setObj]) => ({ key: k, value: setObj ? Object.keys(setObj).length : 0 }))
          .sort((a, b) => (b.value - a.value) || a.key.localeCompare(b.key))
          .slice(0, 500);
        renderRows('philosophyPicks', philosophyPicksRows, fmtInt);
        renderRows('ascendencyPerks', toRows(rollup.ascendencyPerkPurchaseCounts, 50), fmtInt);
        renderRows('philosophyRepeatables', toRows(rollup.philosophyRepeatableCounts, 50), fmtInt);

        renderJsErrors(rollup);
      }

      let rollup = newRollup();
      loadSavedTheme();
      $('theme')?.addEventListener('change', () => applyTheme($('theme').value));

      let refreshInFlight = false;

      async function refresh() {
        if (refreshInFlight) return;
        refreshInFlight = true;

        try {
          $('status').textContent = 'Loading...';

          if (!Array.isArray(rollup.knownRandomEventIds) || rollup.knownRandomEventIds.length === 0) {
            try {
              const idsRes = await fetch('/api/random-event-ids');
              const idsJson = await idsRes.json();
              if (idsRes.ok && Array.isArray(idsJson?.ids)) {
                rollup.knownRandomEventIds = idsJson.ids;
              }
            } catch {
              // ignore
            }
          }

          if (!Array.isArray(rollup.knownAchievementIds) || rollup.knownAchievementIds.length === 0) {
            try {
              const idsRes = await fetch('/api/achievement-ids');
              const idsJson = await idsRes.json();
              if (idsRes.ok && Array.isArray(idsJson?.ids)) {
                rollup.knownAchievementIds = idsJson.ids;
              }
            } catch {
              // ignore
            }
          }

          const after = rollup.cursorAfterIso;
          const url = after ? `/api/events?after=${encodeURIComponent(after)}&inclusive=1` : '/api/events';

          const res = await fetch(url);
          const json = await res.json();
          if (!res.ok) {
            throw new Error(json?.error || 'Failed to fetch events');
          }

          const events = Array.isArray(json.events) ? json.events : [];

          const lastTime = events.length ? events[events.length - 1].event_time : null;
          const prevCursor = rollup.cursorAfterIso;
          const prevTailKeys = rollup.cursorTailKeys && typeof rollup.cursorTailKeys === 'object' ? rollup.cursorTailKeys : {};
          const nextTailKeys = lastTime && lastTime === prevCursor ? { ...prevTailKeys } : {};

          for (const e of events) {
            const isCursorTime = !!prevCursor && e.event_time === prevCursor;
            const key = eventKey(e);
            if (isCursorTime && prevTailKeys[key]) {
              continue;
            }

            applyEvent(rollup, e);

            if (lastTime && e.event_time === lastTime) {
              nextTailKeys[key] = true;
            }
          }

          if (json.nextCursor) {
            rollup.cursorAfterIso = json.nextCursor;
            rollup.cursorTailKeys = nextTailKeys;
          }

          await saveRollup(rollup);
          render(rollup);
          $('status').textContent = 'OK';
        } catch (err) {
          $('status').textContent = `ERROR: ${String(err?.message || err)}`;
        } finally {
          refreshInFlight = false;
        }
      }

      $('btnRefresh').addEventListener('click', refresh);

      $('btnReset').addEventListener('click', async () => {
        if (!confirm('Reset local all-time totals? This cannot be undone.')) return;
        rollup = newRollup();
        await saveRollup(rollup);
        render(rollup);
      });

      $('btnExport').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(rollup, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `cosmicforge_analytics_rollup_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      });

      $('btnImport').addEventListener('click', () => {
        $('fileImport').value = '';
        $('fileImport').click();
      });

      $('fileImport').addEventListener('change', async (ev) => {
        const file = ev.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        const parsed = safeParse(text, null);
        if (!parsed || typeof parsed !== 'object') {
          alert('Invalid JSON');
          return;
        }
        rollup = { ...newRollup(), ...parsed };
        await saveRollup(rollup);
        render(rollup);
      });

      rollup = await loadRollup();
      render(rollup);

      for (const id of ['filterRuntime', 'filterRejections', 'filterWithStack', 'filterOnlyLocal']) {
        const el = $(id);
        if (el) {
          el.addEventListener('change', () => render(rollup));
        }
      }
      setInterval(refresh, 300_000);
      refresh();
    </script>
  </body>
</html>
