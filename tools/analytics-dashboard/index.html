<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cosmic Forge Analytics (Persistent)</title>
    <link rel="stylesheet" href="/tools/analytics-dashboard/styles.css" />
  </head>
  <body data-theme="terminal">
    <header>
      <h1>Cosmic Forge - Analytics Dashboard (Persistent)</h1>
      <div class="controls">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="terminal" selected>Terminal</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="frosty">Frosty</option>
          <option value="summer">Summer</option>
          <option value="forest">Forest</option>
        </select>
        <button id="btnRefresh">Refresh</button>
        <button id="btnExpandAllPanels">Expand panels</button>
        <button id="btnCollapseAllPanels">Collapse panels</button>
        <button id="btnReset">Reset local totals</button>
        <button id="btnExport">Export JSON</button>
        <button id="btnImport">Import JSON</button>
        <span id="status" class="muted"></span>
      </div>
    </header>

    <main>
      <div class="card" data-panel-id="summary">
        <h2>Summary (All-time Local Rollup)</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Events</div><div class="value" id="kpiEvents">-</div></div>
          <div class="kpi"><div class="label">Unique Sessions</div><div class="value" id="kpiSessions">-</div></div>
          <div class="kpi"><div class="label">Clients</div><div class="value" id="kpiClients">-</div></div>
        </div>
        <div style="margin-top:10px" class="muted">
          <span class="mono" id="meta"></span>
        </div>
      </div>

      <div class="card" data-panel-id="pioneerPlaytime">
        <h2>Pioneer Playtime (All-time Active)</h2>
        <table>
          <thead><tr><th>Pioneer</th><th>Total Active Time</th></tr></thead>
          <tbody id="pioneerPlaytime"></tbody>
        </table>
      </div>

      <div class="grid">
        <div class="card span-6">
          <h2>Miaplacidus &amp; Megastructures</h2>
          <table>
            <thead><tr><th>Milestone</th><th>Count</th></tr></thead>
            <tbody id="miaplacidusMegastructures"></tbody>
          </table>
        </div>

        <div class="card span-6" data-panel-id="spaceAnomalies">
          <h2>Space Anomalies</h2>
          <table>
            <thead><tr><th>Metric</th><th>Count</th></tr></thead>
            <tbody id="spaceAnomaliesStats"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Views (ui_view)</h2>
          <table>
            <thead><tr><th>View</th><th>Count</th></tr></thead>
            <tbody id="topViews"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Time Spent (ui_view_duration)</h2>
          <table>
            <thead><tr><th>View</th><th>Total Time</th></tr></thead>
            <tbody id="topDurations"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Achievements (achievement_granted)</h2>
          <table>
            <thead><tr><th>Achievement</th><th>Count</th></tr></thead>
            <tbody id="topAchievements"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Feedback</h2>
          <table>
            <thead><tr><th>Metric</th><th>Count</th></tr></thead>
            <tbody id="feedback"></tbody>
          </table>
        </div>

        <div class="card span-6" data-panel-id="casinoGames">
          <h2>Casino - Games Played</h2>
          <table>
            <thead><tr><th>Game</th><th>Plays</th></tr></thead>
            <tbody id="casinoGames"></tbody>
          </table>
        </div>

        <div class="card span-6" data-panel-id="casinoVisits">
          <h2>Casino - Visits &amp; Time</h2>
          <table>
            <thead><tr><th>Metric</th><th>Value</th></tr></thead>
            <tbody id="casinoVisits"></tbody>
          </table>
        </div>

        <div class="card span-12" data-panel-id="casinoPrizes">
          <h2>Casino - Prizes Won</h2>
          <table>
            <thead><tr><th>Prize</th><th>Wins</th></tr></thead>
            <tbody id="casinoPrizes"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Feedback Comments</h2>
          <div id="feedbackComments" class="mono" style="white-space: pre-wrap; max-height: 260px; overflow: auto;"></div>
        </div>

        <div class="card span-12">
          <h2>Star System Activity</h2>
          <table>
            <thead><tr><th>Star System</th><th>Count</th></tr></thead>
            <tbody id="starSystems"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Theme Selections (Total)</h2>
          <table>
            <thead><tr><th>Theme</th><th>Selections</th></tr></thead>
            <tbody id="themeSelections"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Onboarding</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="onboarding"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Rocket Parts Built</h2>
          <table>
            <thead><tr><th>Rocket</th><th>Parts Built</th></tr></thead>
            <tbody id="rocketPartsBuilt"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Space Actions</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="spaceActions"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Diplomacy Choices</h2>
          <table>
            <thead><tr><th>Choice</th><th>Count</th></tr></thead>
            <tbody id="diplomacyChoices"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Settings Usage (Unique Clients from Snapshots)</h2>
          <table>
            <thead><tr><th>Setting:State</th><th>Clients</th></tr></thead>
            <tbody id="settingsUsage"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Triggered Events</h2>
          <table>
            <thead><tr><th>Event</th><th>Triggered</th></tr></thead>
            <tbody id="triggeredEvents"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Philosophy Picks (Unique Clients)</h2>
          <table>
            <thead><tr><th>Philosophy</th><th>Clients</th></tr></thead>
            <tbody id="philosophyPicks"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Best Selling Ascendency Perks</h2>
          <table>
            <thead><tr><th>Perk</th><th>Purchases</th></tr></thead>
            <tbody id="ascendencyPerks"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Most Researched Philosophy Repeatables</h2>
          <table>
            <thead><tr><th>Philosophy:Tech</th><th>Research Count</th></tr></thead>
            <tbody id="philosophyRepeatables"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>JS Errors</h2>
          <div class="controls" style="margin-bottom: 10px; gap: 14px;">
            <label><input type="checkbox" id="filterRuntime" checked /> Runtime</label>
            <label><input type="checkbox" id="filterRejections" checked /> Rejections</label>
            <label><input type="checkbox" id="filterWithStack" checked /> Only with stack</label>
            <label><input type="checkbox" id="filterOnlyLocal" /> Only local scripts</label>
            <span id="jsErrorSelectedCount" class="muted mono"></span>
            <button id="btnDeleteSelectedJsErrors">Delete selected</button>
          </div>
          <table>
            <thead><tr><th></th><th>Count</th><th>Last Seen</th><th>Type</th><th>Message</th><th>Location</th><th></th></tr></thead>
            <tbody id="jsErrors"></tbody>
          </table>
          <div id="jsErrorDetails" class="mono" style="white-space: pre-wrap; margin-top: 10px; max-height: 320px; overflow: auto;"></div>
        </div>
      </div>
    </main>

    <input id="fileImport" type="file" accept="application/json" style="display:none" />

    <script type="module">
      const $ = (id) => document.getElementById(id);

      const selectedJsErrorSignatures = new Set();

      const THEME_STORAGE_KEY = 'analytics_dashboard_theme';
      const PANEL_STATE_STORAGE_KEY = 'analytics_dashboard_panels_state_v1';
      const PANEL_ORDER_STORAGE_KEY = 'analytics_dashboard_panels_order_v1';

      function safeParse(value, fallback) {
        try {
          return JSON.parse(value);
        } catch {
          return fallback;
        }
      }

      function slugifyPanelId(value) {
        return String(value || '')
          .toLowerCase()
          .replace(/&/g, 'and')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64) || 'panel';
      }

      function getPanelId(card) {
        const explicit = card?.dataset?.panelId;
        if (explicit) return explicit;
        const title = card?.querySelector('h2')?.textContent;
        return slugifyPanelId(title);
      }

      function loadPanelState() {
        try {
          return safeParse(localStorage.getItem(PANEL_STATE_STORAGE_KEY), {}) || {};
        } catch {
          return {};
        }
      }

      function savePanelState(state) {
        try {
          localStorage.setItem(PANEL_STATE_STORAGE_KEY, JSON.stringify(state || {}));
        } catch {
        }
      }

      function loadPanelOrder() {
        try {
          const parsed = safeParse(localStorage.getItem(PANEL_ORDER_STORAGE_KEY), null);
          return Array.isArray(parsed) ? parsed : null;
        } catch {
          return null;
        }
      }

      function savePanelOrder(order) {
        try {
          localStorage.setItem(PANEL_ORDER_STORAGE_KEY, JSON.stringify(order || []));
        } catch {
        }
      }

      function setPanelCollapsed(card, collapsed, state) {
        const id = getPanelId(card);
        card.classList.toggle('collapsed', !!collapsed);
        const btn = card.querySelector('.panel-toggle');
        if (btn) {
          btn.textContent = collapsed ? '▶' : '▼';
          btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        }
        if (state && id) state[id] = !!collapsed;
      }

      function ensurePanelHeader(card, state) {
        if (!card || !(card instanceof HTMLElement)) return;
        if (card.querySelector(':scope > .panel-header')) return;
        const h2 = card.querySelector(':scope > h2');
        if (!h2) return;

        const header = document.createElement('div');
        header.className = 'panel-header drag-handle';
        header.draggable = true;

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'panel-toggle';
        toggle.setAttribute('aria-label', 'Toggle panel');

        toggle.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          const id = getPanelId(card);
          const nextCollapsed = !card.classList.contains('collapsed');
          setPanelCollapsed(card, nextCollapsed, state);
          savePanelState(state);
        });

        header.appendChild(toggle);
        header.appendChild(h2);
        card.insertBefore(header, card.firstChild);

        const id = getPanelId(card);
        const collapsed = !!state[id];
        setPanelCollapsed(card, collapsed, state);
      }

      function initPanels() {
        const state = loadPanelState();
        const cards = Array.from(document.querySelectorAll('.card'));
        for (const card of cards) {
          ensurePanelHeader(card, state);
        }

        const grid = document.querySelector('.grid');
        if (!grid) return;

        const desiredOrder = loadPanelOrder();
        if (desiredOrder && desiredOrder.length) {
          const gridCards = Array.from(grid.querySelectorAll(':scope > .card'));
          const map = new Map(gridCards.map((c) => [getPanelId(c), c]));
          for (const id of desiredOrder) {
            const el = map.get(id);
            if (el) grid.appendChild(el);
          }
        }

        let draggingCard = null;
        const getClosestCard = (x, y) => {
          const items = Array.from(grid.querySelectorAll(':scope > .card'))
            .filter((c) => c !== draggingCard);
          let closest = null;
          let closestDist = Infinity;
          for (const item of items) {
            const r = item.getBoundingClientRect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            const dx = cx - x;
            const dy = cy - y;
            const dist = dx * dx + dy * dy;
            if (dist < closestDist) {
              closestDist = dist;
              closest = item;
            }
          }
          return closest;
        };

        grid.addEventListener('dragstart', (ev) => {
          const handle = ev.target?.closest?.('.drag-handle');
          if (!handle) return;
          const card = handle.closest('.card');
          if (!card || !grid.contains(card)) return;
          draggingCard = card;
          draggingCard.classList.add('dragging');
          try {
            ev.dataTransfer.effectAllowed = 'move';
            ev.dataTransfer.setData('text/plain', getPanelId(card));
          } catch {
          }
        });

        grid.addEventListener('dragend', () => {
          if (draggingCard) {
            draggingCard.classList.remove('dragging');
            draggingCard = null;
            const order = Array.from(grid.querySelectorAll(':scope > .card')).map(getPanelId);
            savePanelOrder(order);
          }
        });

        grid.addEventListener('dragover', (ev) => {
          if (!draggingCard) return;
          ev.preventDefault();
          const closest = getClosestCard(ev.clientX, ev.clientY);
          if (!closest || closest === draggingCard) return;
          const r = closest.getBoundingClientRect();
          const before = ev.clientY < (r.top + r.height / 2);
          grid.insertBefore(draggingCard, before ? closest : closest.nextSibling);
        });

        savePanelState(state);
      }

      function isLocalScript(filename) {
        if (!filename) return false;
        const s = String(filename);
        if (s.startsWith('/')) return true;
        if (!s.includes('://')) return true;
        if (window.location && typeof window.location.origin === 'string') {
          return s.startsWith(window.location.origin);
        }
        return false;
      }

      function updateJsErrorSelectedCount() {
        const el = $('jsErrorSelectedCount');
        if (!el) return;
        const n = selectedJsErrorSignatures.size;
        el.textContent = n > 0 ? `selected=${n}` : '';
      }


      function renderJsErrors(rollup) {
        const tbody = $('jsErrors');
        if (!tbody) return;

        const showRuntime = $('filterRuntime') ? $('filterRuntime').checked : true;
        const showRejections = $('filterRejections') ? $('filterRejections').checked : true;
        const onlyWithStack = $('filterWithStack') ? $('filterWithStack').checked : false;
        const onlyLocal = $('filterOnlyLocal') ? $('filterOnlyLocal').checked : false;

        const hidden = rollup.hiddenJsErrorSignatures && typeof rollup.hiddenJsErrorSignatures === 'object'
          ? rollup.hiddenJsErrorSignatures
          : {};

        const entries = Object.entries(rollup.jsErrorSignatures || {})
          .filter(([signature]) => !hidden[signature])
          .map(([signature, rec]) => ({ signature, ...rec }));

        const filtered = entries.filter((rec) => {
          const sample = rec.sample || {};
          const eventName = sample.event_name || '';
          if (!showRuntime && eventName === 'js_error') return false;
          if (!showRejections && eventName === 'unhandled_promise_rejection') return false;
          if (onlyWithStack && !(typeof sample.stack === 'string' && sample.stack.trim().length > 0)) return false;
          if (onlyLocal && !isLocalScript(sample.filename)) return false;
          return true;
        });

        filtered.sort((a, b) => (b.count || 0) - (a.count || 0));

        tbody.innerHTML = '';
        for (const rec of filtered.slice(0, 500)) {
          const sample = rec.sample || {};
          const tr = document.createElement('tr');

          const tdSel = document.createElement('td');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selectedJsErrorSignatures.has(rec.signature);
          cb.addEventListener('change', () => {
            if (cb.checked) {
              selectedJsErrorSignatures.add(rec.signature);
            } else {
              selectedJsErrorSignatures.delete(rec.signature);
            }
            updateJsErrorSelectedCount();
          });
          tdSel.appendChild(cb);

          const tdCount = document.createElement('td');
          tdCount.textContent = fmtInt(rec.count || 0);
          tdCount.className = 'mono';

          const tdLast = document.createElement('td');
          tdLast.textContent = rec.lastSeen || '-';
          tdLast.className = 'mono';

          const tdType = document.createElement('td');
          tdType.textContent = sample.event_name || '-';
          tdType.className = 'mono';

          const tdMsg = document.createElement('td');
          tdMsg.textContent = sample.message || '(no message)';
          tdMsg.className = 'mono';

          const tdLoc = document.createElement('td');
          const loc = `${sample.filename || '-'}:${sample.lineno ?? '-'}:${sample.colno ?? '-'}`;
          tdLoc.textContent = loc;
          tdLoc.className = 'mono';

          const tdBtn = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = 'View';
          btn.addEventListener('click', () => {
            const details = [
              `event=${sample.event_name || ''}`,
              `count=${rec.count || 0}`,
              `lastSeen=${rec.lastSeen || ''}`,
              `name=${sample.name || ''}`,
              `message=${sample.message || ''}`,
              `file=${sample.filename || ''}`,
              `line=${sample.lineno ?? ''}`,
              `col=${sample.colno ?? ''}`,
              `path=${sample.path || ''}`,
              '',
              'stack:',
              sample.stack || '(no stack)'
            ].join('\n');
            $('jsErrorDetails').textContent = details;
          });
          tdBtn.appendChild(btn);

          tr.appendChild(tdSel);
          tr.appendChild(tdCount);
          tr.appendChild(tdLast);
          tr.appendChild(tdType);
          tr.appendChild(tdMsg);
          tr.appendChild(tdLoc);
          tr.appendChild(tdBtn);
          tbody.appendChild(tr);
        }

        if (filtered.length === 0) {
          $('jsErrorDetails').textContent = '(no errors match filters)';
        }

        updateJsErrorSelectedCount();
      }

      function nowIso() {
        return new Date().toISOString();
      }

      function fmtInt(n) {
        return typeof n === 'number' && Number.isFinite(n) ? n.toLocaleString() : '-';
      }

      function fmtDuration(ms) {
        if (typeof ms !== 'number' || !Number.isFinite(ms)) return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const s = totalSeconds % 60;
        const totalMinutes = Math.floor(totalSeconds / 60);
        const m = totalMinutes % 60;
        const h = Math.floor(totalMinutes / 60);
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }

      function newRollup() {
        return {
          version: 1,
          createdAt: nowIso(),
          updatedAt: nowIso(),
          cursorAfterIso: null,
          cursorTailKeys: {},

          // Keep event ids to render triggered events with 0s.
          knownRandomEventIds: [],
          knownAchievementIds: [],

          // Feedback
          feedbackThumbUp: 0,
          feedbackThumbDown: 0,
          feedbackAccepted: 0,
          feedbackRefused: 0,
          feedbackComments: [],

          casinoGamePlayCounts: {},
          casinoPrizeWinCounts: {},

          jsErrorSignatures: {},
          hiddenJsErrorSignatures: {},

          // Sets
          uniqueSessions: {},
          uniqueClients: {},
          pioneersSeen: {},

          // Unique sets
          blackHoleDiscoveredClients: {},
          blackHoleResearchedClients: {},
          legendaryAsteroidClients: {},
          oStarReachedCountsByStar: {},

          // Totals
          totalEvents: 0,

          // KPI totals
          miaplacidusReached: 0,
          miaplacidusForcefieldDown: 0,
          miaplacidusSettled: 0,
          legendaryAsteroidDiscoveries: 0,

          // Megastructures
          megastructureCapturedCounts: {},

          // Playtime
          pioneerPlaytimeMs: {},

          // View/click/achievement breakdown
          viewCounts: {},
          viewDurationMs: {},
          clickCounts: {},
          achievementCounts: {},
          starSystemSeenCounts: {},

          // Theme + onboarding
          themeSelectionCounts: {},
          onboardingPromptYes: 0,
          onboardingPromptNo: 0,
          onboardingExit: 0,

          // Rocket parts built
          rocketPartBuildCounts: {},

          // Counts
          starshipLaunched: 0,
          settleSystem: 0,
          diplomacyChoiceCounts: {},
          triggeredEventCounts: {},

          philosophyPickClientsById: {},
          ascendencyPerkPurchaseCounts: {},
          philosophyRepeatableCounts: {},

          // Settings unique clients snapshot
          settingsSnapshotClientsByKeyValue: {},
        };
      }

      function applyTheme(theme) {
        if (!theme) return;
        document.body.setAttribute('data-theme', theme);
        try {
          localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch {
          // ignore
        }
      }

      function loadSavedTheme() {
        let saved = null;
        try {
          saved = localStorage.getItem(THEME_STORAGE_KEY);
        } catch {
          saved = null;
        }
        const theme = saved || 'terminal';
        const sel = $('theme');
        if (sel) sel.value = theme;
        applyTheme(theme);
      }

      async function loadRollup() {
        try {
          const res = await fetch('/api/persistent-rollup');
          const json = await res.json();
          if (!res.ok) throw new Error(json?.error || 'Failed to load rollup');
          const parsed = json?.rollup;
          if (!parsed || typeof parsed !== 'object') {
            return newRollup();
          }
          return { ...newRollup(), ...parsed };
        } catch {
          return newRollup();
        }
      }

      async function saveRollup(next) {
        try {
          await fetch('/api/persistent-rollup', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rollup: next }),
          });
        } catch {
          // ignore
        }
      }

      function addToSetObject(setObj, key) {
        if (!key) return;
        setObj[key] = true;
      }

      function inc(mapObj, key, amount = 1) {
        if (!key) return;
        mapObj[key] = (mapObj[key] || 0) + amount;
      }

      function normKey(value, fallback = null) {
        const s = String(value ?? '').trim();
        return s.length ? s : fallback;
      }

      function eventKey(e) {
        const payload = e.payload && typeof e.payload === 'object' ? e.payload : {};
        return `${e.event_time || ''}|${e.event_name || ''}|${e.client_id || ''}|${e.session_id || ''}|${e.pioneer_name || ''}|${JSON.stringify(payload)}`;
      }

      function applyEvent(rollup, e) {
        rollup.totalEvents += 1;

        if (e.session_id) addToSetObject(rollup.uniqueSessions, e.session_id);
        if (e.client_id) addToSetObject(rollup.uniqueClients, e.client_id);
        if (e.pioneer_name) addToSetObject(rollup.pioneersSeen, e.pioneer_name);

        const payload = e.payload && typeof e.payload === 'object' ? e.payload : {};

        if (e.event_name === 'ui_view') {
          const viewId = normKey(payload.view_id, 'unknown');
          inc(rollup.viewCounts, viewId, 1);
        }

        if (e.event_name === 'ui_view_duration') {
          const ms = typeof payload.duration_ms === 'number' ? payload.duration_ms : 0;
          const pioneer = normKey(e.pioneer_name, null);
          if (pioneer) {
            rollup.pioneerPlaytimeMs[pioneer] = (rollup.pioneerPlaytimeMs[pioneer] || 0) + Math.max(0, ms);
          }

          const viewId = normKey(payload.view_id, 'unknown');
          rollup.viewDurationMs[viewId] = (rollup.viewDurationMs[viewId] || 0) + Math.max(0, ms);
        }

        if (e.event_name === 'dom_click') {
          const id = payload.id ? `#${payload.id}` : '(no id)';
          const tag = payload.tag ? String(payload.tag).toUpperCase() : '(no tag)';
          const key = `${tag} ${id}`;
          inc(rollup.clickCounts, key, 1);
        }

        if (e.event_name === 'achievement_granted') {
          const id = normKey(payload.achievement_id, 'unknown');
          inc(rollup.achievementCounts, id, 1);
        }

        if (e.event_name === 'feedback_thumb_up') {
          rollup.feedbackThumbUp = (rollup.feedbackThumbUp || 0) + 1;
        }

        if (e.event_name === 'feedback_thumb_down') {
          rollup.feedbackThumbDown = (rollup.feedbackThumbDown || 0) + 1;
        }

        if (e.event_name === 'casino_game_played') {
          const gameId = normKey(payload.game_id, 'unknown');
          if (!rollup.casinoGamePlayCounts || typeof rollup.casinoGamePlayCounts !== 'object') rollup.casinoGamePlayCounts = {};
          inc(rollup.casinoGamePlayCounts, gameId, 1);
        }

        if (e.event_name === 'casino_prize_won') {
          const prizeKey = normKey(payload.prize_key, 'unknown');
          if (!rollup.casinoPrizeWinCounts || typeof rollup.casinoPrizeWinCounts !== 'object') rollup.casinoPrizeWinCounts = {};
          inc(rollup.casinoPrizeWinCounts, prizeKey, 1);
        }

        if (e.event_name === 'feedback_response') {
          if (payload.action === 'accepted') rollup.feedbackAccepted = (rollup.feedbackAccepted || 0) + 1;
          if (payload.action === 'refused') rollup.feedbackRefused = (rollup.feedbackRefused || 0) + 1;

          const comment = typeof payload.comment === 'string' ? payload.comment.trim() : '';
          if (comment.length > 0) {
            if (!Array.isArray(rollup.feedbackComments)) rollup.feedbackComments = [];
            rollup.feedbackComments.push(comment);
          }
        }

        if (e.event_name === 'js_error' || e.event_name === 'unhandled_promise_rejection') {
          const message = normKey(payload.message, '(no message)');
          const filename = normKey(payload.filename, null);
          const lineno = Number.isFinite(payload.lineno) ? payload.lineno : null;
          const colno = Number.isFinite(payload.colno) ? payload.colno : null;
          const signature = `${e.event_name}|${message}|${filename || ''}|${lineno || ''}|${colno || ''}`;

          const mapObj = rollup.jsErrorSignatures || (rollup.jsErrorSignatures = {});
          if (!mapObj[signature]) {
            if (Object.keys(mapObj).length >= 500) return;
            mapObj[signature] = {
              count: 0,
              lastSeen: null,
              sample: null
            };
          }

          mapObj[signature].count = (mapObj[signature].count || 0) + 1;
          mapObj[signature].lastSeen = e.event_time || mapObj[signature].lastSeen;
          if (!mapObj[signature].sample) {
            mapObj[signature].sample = {
              event_name: e.event_name,
              message,
              name: payload.name ?? null,
              filename,
              lineno,
              colno,
              stack: typeof payload.stack === 'string' ? payload.stack : null,
              path: payload.path ?? null
            };
          }
        }

        if (e.event_name === 'star_system_changed' || e.event_name === 'star_system_seen') {
          const sys = normKey(payload.to ?? payload.star_system, 'unknown');
          inc(rollup.starSystemSeenCounts, sys, 1);
        }

        if (e.event_name === 'milestone_reached') {
          if (payload.milestone_id === 'reached_star_miaplacidus') {
            rollup.miaplacidusReached += 1;
          }
        }

        if (e.event_name === 'megastructure_captured') {
          const id = Number(payload.megastructure_id);
          if (Number.isFinite(id) && id >= 1 && id <= 4) {
            inc(rollup.megastructureCapturedCounts, String(id), 1);
          }
        }

        if (e.event_name === 'miaplacidus_forcefield_down') {
          rollup.miaplacidusForcefieldDown += 1;
        }

        if (e.event_name === 'miaplacidus_settled') {
          rollup.miaplacidusSettled += 1;
        }

        if (e.event_name === 'black_hole_discovered') {
          if (e.client_id) addToSetObject(rollup.blackHoleDiscoveredClients, e.client_id);
        }

        if (e.event_name === 'black_hole_research_completed') {
          if (e.client_id) addToSetObject(rollup.blackHoleResearchedClients, e.client_id);
        }

        if (e.event_name === 'legendary_asteroid_discovered') {
          rollup.legendaryAsteroidDiscoveries += 1;
          if (e.client_id) addToSetObject(rollup.legendaryAsteroidClients, e.client_id);
        }

        if (e.event_name === 'o_star_reached') {
          const star = String(payload.star_system || '').trim().toLowerCase();
          if (!star) return;
          if (!rollup.oStarReachedCountsByStar || typeof rollup.oStarReachedCountsByStar !== 'object') {
            rollup.oStarReachedCountsByStar = {};
          }
          rollup.oStarReachedCountsByStar[star] = (rollup.oStarReachedCountsByStar[star] || 0) + 1;
        }

        if (e.event_name === 'theme_selected') {
          const themeId = normKey(payload.theme_id, 'unknown');
          inc(rollup.themeSelectionCounts, themeId, 1);
        }

        if (e.event_name === 'onboarding_prompt_yes') {
          rollup.onboardingPromptYes += 1;
        }

        if (e.event_name === 'onboarding_prompt_no') {
          rollup.onboardingPromptNo += 1;
        }

        if (e.event_name === 'onboarding_exit') {
          rollup.onboardingExit += 1;
        }

        if (e.event_name === 'rocket_part_built') {
          const rocketId = normKey(payload.rocket_id, 'unknown');
          inc(rollup.rocketPartBuildCounts, rocketId, 1);
        }

        if (e.event_name === 'philosophy_selected') {
          const philosophyId = normKey(payload.philosophy_id, 'unknown');
          if (!rollup.philosophyPickClientsById[philosophyId]) {
            rollup.philosophyPickClientsById[philosophyId] = {};
          }
          const uniqueKey = e.client_id || e.session_id;
          if (uniqueKey) {
            rollup.philosophyPickClientsById[philosophyId][uniqueKey] = true;
          }
        }

        if (e.event_name === 'ascendency_perk_purchased') {
          const perkId = normKey(payload.perk_id, 'unknown');
          inc(rollup.ascendencyPerkPurchaseCounts, perkId, 1);
        }

        if (e.event_name === 'philosophy_repeatable_researched') {
          const philosophyId = normKey(payload.philosophy_id, 'unknown');
          const techId = normKey(payload.tech_id, 'unknown');
          const k = `${philosophyId}:${techId}`;
          inc(rollup.philosophyRepeatableCounts, k, 1);

          if (!rollup.philosophyPickClientsById[philosophyId]) {
            rollup.philosophyPickClientsById[philosophyId] = {};
          }
          const uniqueKey = e.client_id || e.session_id;
          if (uniqueKey) {
            rollup.philosophyPickClientsById[philosophyId][uniqueKey] = true;
          }
        }

        if (e.event_name === 'starship_launched') {
          rollup.starshipLaunched += 1;
        }

        if (e.event_name === 'settle_system') {
          rollup.settleSystem += 1;
        }

        if (e.event_name === 'diplomacy_choice') {
          const choice = normKey(payload.choice, 'unknown');
          inc(rollup.diplomacyChoiceCounts, choice, 1);
        }

        if (e.event_name === 'random_event_triggered') {
          const eventId = normKey(payload.event_id, 'unknown');
          inc(rollup.triggeredEventCounts, eventId, 1);
        }

        if (e.event_name === 'settings_snapshot') {
          const pairs = [
            ['background_audio', !!payload.background_audio],
            ['sfx', !!payload.sfx],
            ['custom_pointer', !!payload.custom_pointer],
            ['mouse_trail', !!payload.mouse_trail],
          ];

          for (const [settingId, enabled] of pairs) {
            const k = `${settingId}:${enabled ? 'on' : 'off'}`;
            if (!rollup.settingsSnapshotClientsByKeyValue[k]) {
              rollup.settingsSnapshotClientsByKeyValue[k] = {};
            }
            if (e.client_id) {
              rollup.settingsSnapshotClientsByKeyValue[k][e.client_id] = true;
            }
          }
        }
      }

      function renderRows(tbodyId, rows, formatValue) {
        const tbody = $(tbodyId);
        tbody.innerHTML = '';
        for (const row of rows) {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          const td2 = document.createElement('td');
          td1.textContent = row.key;
          td1.className = 'mono';
          td2.textContent = formatValue(row.value);
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        }
      }

      function render(rollup) {
        const sessions = Object.keys(rollup.uniqueSessions || {}).length;
        const clients = Object.keys(rollup.uniqueClients || {}).length;

        const blackHoleDiscovered = Object.keys(rollup.blackHoleDiscoveredClients || {}).length;
        const blackHoleResearched = Object.keys(rollup.blackHoleResearchedClients || {}).length;

        $('kpiEvents').textContent = fmtInt(rollup.totalEvents);
        $('kpiSessions').textContent = fmtInt(sessions);
        $('kpiClients').textContent = fmtInt(clients);

        const legendaryAsteroidUniqueClients = Object.keys(rollup.legendaryAsteroidClients || {}).length;
        const oStarMintaka = rollup.oStarReachedCountsByStar?.mintaka || 0;
        const oStarRegulus = rollup.oStarReachedCountsByStar?.regulus || 0;
        const oStarMenkalinan = rollup.oStarReachedCountsByStar?.menkalinan || 0;

        $('meta').textContent = `cursorAfter=${rollup.cursorAfterIso ?? '-'} updatedAt=${rollup.updatedAt}`;

        const playtimeRows = Object.entries(rollup.pioneerPlaytimeMs || {})
          .map(([key, value]) => ({ key, value }))
          .sort((a, b) => b.value - a.value)
          .slice(0, 500);
        renderRows('pioneerPlaytime', playtimeRows, fmtDuration);

        const toRows = (obj, limit = 500) => {
          const rows = Object.entries(obj || {}).map(([key, value]) => ({ key, value }));
          rows.sort((a, b) => b.value - a.value);
          return rows.slice(0, limit);
        };

        renderRows('topViews', toRows(rollup.viewCounts, 30), fmtInt);
        renderRows('topDurations', toRows(rollup.viewDurationMs, 30), fmtDuration);
        const achievementIds = Array.isArray(rollup.knownAchievementIds) ? rollup.knownAchievementIds : [];
        const achievementRows = achievementIds.length
          ? achievementIds
            .map((id) => ({ key: id, value: rollup.achievementCounts?.[id] || 0 }))
            .sort((a, b) => (b.value - a.value) || a.key.localeCompare(b.key))
          : toRows(rollup.achievementCounts, 200);
        renderRows('topAchievements', achievementRows, fmtInt);
        renderRows('starSystems', toRows(rollup.starSystemSeenCounts, 30), fmtInt);
        renderRows('themeSelections', toRows(rollup.themeSelectionCounts, 50), fmtInt);

        const capture1 = (rollup.megastructureCapturedCounts || {})['1'] || 0;
        const capture2 = (rollup.megastructureCapturedCounts || {})['2'] || 0;
        const capture3 = (rollup.megastructureCapturedCounts || {})['3'] || 0;
        const capture4 = (rollup.megastructureCapturedCounts || {})['4'] || 0;
        renderRows('miaplacidusMegastructures', [
          { key: 'Megastructure 1 captured', value: capture1 },
          { key: 'Megastructure 2 captured', value: capture2 },
          { key: 'Megastructure 3 captured', value: capture3 },
          { key: 'Megastructure 4 captured', value: capture4 },
          { key: 'Miaplacidus force field down', value: rollup.miaplacidusForcefieldDown || 0 },
          { key: 'Miaplacidus settled (win cinematic)', value: rollup.miaplacidusSettled || 0 },
        ], fmtInt);

        renderRows('spaceAnomaliesStats', [
          { key: 'Black Hole discovered (clients)', value: blackHoleDiscovered },
          { key: 'Black Hole researched (clients)', value: blackHoleResearched },
          { key: 'Legendary Asteroids discovered (total)', value: rollup.legendaryAsteroidDiscoveries || 0 },
          { key: 'Legendary Asteroids discovered (clients)', value: legendaryAsteroidUniqueClients },
          { key: 'O-star reached: Mintaka (total)', value: oStarMintaka },
          { key: 'O-star reached: Regulus (total)', value: oStarRegulus },
          { key: 'O-star reached: Menkalinan (total)', value: oStarMenkalinan },
        ], fmtInt);

        renderRows('onboarding', [
          { key: 'Enter onboarding (YES)', value: rollup.onboardingPromptYes || 0 },
          { key: 'Decline onboarding (NO)', value: rollup.onboardingPromptNo || 0 },
          { key: 'Exit onboarding', value: rollup.onboardingExit || 0 },
        ], fmtInt);

        renderRows('rocketPartsBuilt', toRows(rollup.rocketPartBuildCounts, 10), fmtInt);

        renderRows('spaceActions', [
          { key: 'Starship launched', value: rollup.starshipLaunched || 0 },
          { key: 'Settle system', value: rollup.settleSystem || 0 },
        ], fmtInt);

        const diplomacyRows = ['bully', 'passive', 'harmony', 'vassalize', 'conquest'].map((c) => ({
          key: c,
          value: rollup.diplomacyChoiceCounts?.[c] || 0,
        }));
        renderRows('diplomacyChoices', diplomacyRows, fmtInt);

        const settingsKeys = [
          'background_audio:on',
          'background_audio:off',
          'sfx:on',
          'sfx:off',
          'custom_pointer:on',
          'custom_pointer:off',
          'mouse_trail:on',
          'mouse_trail:off',
        ];
        const settingsRows = settingsKeys.map((k) => ({
          key: k,
          value: rollup.settingsSnapshotClientsByKeyValue?.[k] ? Object.keys(rollup.settingsSnapshotClientsByKeyValue[k]).length : 0,
        }));
        renderRows('settingsUsage', settingsRows, fmtInt);

        const triggeredIds = Array.isArray(rollup.knownRandomEventIds)
          ? rollup.knownRandomEventIds.filter((id) => id !== 'modalReplacements')
          : [];
        const triggeredRows = triggeredIds.length
          ? triggeredIds.map((id) => ({ key: id, value: rollup.triggeredEventCounts?.[id] || 0 }))
          : toRows(rollup.triggeredEventCounts, 50);
        renderRows('triggeredEvents', triggeredRows, fmtInt);

        renderRows('feedback', [
          { key: 'Thumbs up', value: rollup.feedbackThumbUp || 0 },
          { key: 'Thumbs down', value: rollup.feedbackThumbDown || 0 },
          { key: 'Accepted (SEND FEEDBACK)', value: rollup.feedbackAccepted || 0 },
          { key: 'Refused (NO THANKS)', value: rollup.feedbackRefused || 0 },
        ], fmtInt);

        const casinoGameRows = ['game1_double_or_nothing', 'game2_wheel', 'game2_wheel_special', 'game3_hilo']
          .map((id) => ({ key: id, value: rollup.casinoGamePlayCounts?.[id] || 0 }));
        renderRows('casinoGames', casinoGameRows, fmtInt);

        const casinoViewKeys = Object.keys(rollup.viewCounts || {}).filter((k) => String(k).endsWith(':galactic casino'));
        const casinoVisitCount = casinoViewKeys.reduce((sum, k) => sum + (rollup.viewCounts?.[k] || 0), 0);

        const casinoDurationKeys = Object.keys(rollup.viewDurationMs || {}).filter((k) => String(k).endsWith(':galactic casino'));
        const casinoDurationMs = casinoDurationKeys.reduce((sum, k) => sum + (rollup.viewDurationMs?.[k] || 0), 0);

        renderRows('casinoVisits', [
          { key: 'Visits', value: casinoVisitCount },
          { key: 'Time spent', value: casinoDurationMs },
        ], (v) => (typeof v === 'number' ? (v === casinoDurationMs ? fmtDuration(v) : fmtInt(v)) : '-'));

        const knownCasinoPrizeKeys = [
          'game1_stake_doubled',
          'cp',
          'cash',
          'research',
          'time',
          'resources',
          'compounds',
          'special_100cp',
          'special_100k_research',
          'special_starship_warp',
          'special_rocket_warp',
          'special_finish_rocket_journey',
          'special_finish_starship_journey',
          'special_telescope_finish_asteroid_search',
          'special_telescope_finish_star_study',
          'special_telescope_finish_void_pillage',
          'special_double_hydrogen',
          'special_double_carbon',
          'special_double_silicon',
          'special_double_iron',
          'special_double_sodium',
          'special_double_steel',
          'special_double_concrete',
          'special_double_titanium',
          'hilo_resource_topup',
          'hilo_compound_topup',
          'hilo_cash_boost_small',
          'hilo_cash_boost_medium',
          'hilo_cash_boost_large',
          'hilo_cash_flat',
          'hilo_cash_mega',
          'hilo_research_boost_small',
          'hilo_research_boost_medium',
          'hilo_research_boost_large',
          'hilo_research_flat',
          'hilo_research_big_flat',
          'hilo_research_mega',
          'hilo_cp_5',
          'hilo_cp_10',
          'hilo_cp_25',
          'hilo_cp_50',
          'hilo_cp_75',
          'hilo_cp_100',
          'hilo_cp_150',
          'hilo_timewarp_25_20000',
          'hilo_timewarp_50_15000',
          'hilo_timewarp_75_15000',
          'hilo_timewarp_100_12000',
          'hilo_timewarp_200_20000',
        ];

        const seenCasinoPrizeKeys = Object.keys(rollup.casinoPrizeWinCounts || {});
        const prizeKeySet = new Set([...knownCasinoPrizeKeys, ...seenCasinoPrizeKeys]);
        const casinoPrizeRows = Array.from(prizeKeySet)
          .map((k) => ({ key: k, value: rollup.casinoPrizeWinCounts?.[k] || 0 }))
          .sort((a, b) => (b.value - a.value) || a.key.localeCompare(b.key));
        renderRows('casinoPrizes', casinoPrizeRows, fmtInt);

        const comments = Array.isArray(rollup.feedbackComments) ? rollup.feedbackComments : [];
        $('feedbackComments').textContent = comments.length
          ? comments.map((c, i) => `${i + 1}. ${c}`).join('\n\n')
          : '(no comments)';

        const philosophyPicksRows = Object.entries(rollup.philosophyPickClientsById || {})
          .map(([k, setObj]) => ({ key: k, value: setObj ? Object.keys(setObj).length : 0 }))
          .sort((a, b) => (b.value - a.value) || a.key.localeCompare(b.key))
          .slice(0, 500);
        renderRows('philosophyPicks', philosophyPicksRows, fmtInt);
        renderRows('ascendencyPerks', toRows(rollup.ascendencyPerkPurchaseCounts, 50), fmtInt);
        renderRows('philosophyRepeatables', toRows(rollup.philosophyRepeatableCounts, 50), fmtInt);
        renderJsErrors(rollup);
      }

      let rollup = newRollup();
      initPanels();
      loadSavedTheme();
      $('theme')?.addEventListener('change', () => applyTheme($('theme').value));

      let refreshInFlight = false;

      async function refresh() {
        if (refreshInFlight) return;
        refreshInFlight = true;

        try {
          $('status').textContent = 'Loading...';
          rollup = await loadRollup();
          render(rollup);
          $('status').textContent = 'OK';
        } catch (err) {
          $('status').textContent = `ERROR: ${String(err?.message || err)}`;
        } finally {
          refreshInFlight = false;
        }
      }

      $('btnRefresh').addEventListener('click', refresh);

      $('btnExpandAllPanels')?.addEventListener('click', () => {
        const state = loadPanelState();
        for (const card of document.querySelectorAll('.card')) {
          setPanelCollapsed(card, false, state);
        }
        savePanelState(state);
      });

      $('btnCollapseAllPanels')?.addEventListener('click', () => {
        const state = loadPanelState();
        for (const card of document.querySelectorAll('.card')) {
          setPanelCollapsed(card, true, state);
        }
        savePanelState(state);
      });

      $('btnReset').addEventListener('click', async () => {
        if (!confirm('Reset local all-time totals? This cannot be undone.')) return;
        rollup = newRollup();
        await saveRollup(rollup);
        render(rollup);
      });

      $('btnExport').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(rollup, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `cosmicforge_analytics_rollup_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      });

      $('btnImport').addEventListener('click', () => {
        $('fileImport').value = '';
        $('fileImport').click();
      });

      $('fileImport').addEventListener('change', async (ev) => {
        const file = ev.target.files?.[0];
        if (!file) return;
        const text = await file.text();
        const parsed = safeParse(text, null);
        if (!parsed || typeof parsed !== 'object') {
          alert('Invalid JSON');
          return;
        }
        rollup = { ...newRollup(), ...parsed };
        await saveRollup(rollup);
        render(rollup);
      });

      $('btnDeleteSelectedJsErrors')?.addEventListener('click', async () => {
        const signatures = Array.from(selectedJsErrorSignatures);
        if (signatures.length === 0) {
          alert('No error signatures selected.');
          return;
        }
        if (!confirm(`Delete ${signatures.length} selected error signature(s) from this rollup?`)) return;

        if (!rollup.jsErrorSignatures || typeof rollup.jsErrorSignatures !== 'object') {
          rollup.jsErrorSignatures = {};
        }

        if (!rollup.hiddenJsErrorSignatures || typeof rollup.hiddenJsErrorSignatures !== 'object') {
          rollup.hiddenJsErrorSignatures = {};
        }

        for (const sig of signatures) {
          delete rollup.jsErrorSignatures[sig];
          rollup.hiddenJsErrorSignatures[sig] = true;
        }
        selectedJsErrorSignatures.clear();

        await saveRollup(rollup);
        render(rollup);
      });

      rollup = await loadRollup();
      render(rollup);

      for (const id of ['filterRuntime', 'filterRejections', 'filterWithStack', 'filterOnlyLocal']) {
        const el = $(id);
        if (el) {
          el.addEventListener('change', () => render(rollup));
        }
      }
      setInterval(refresh, 300_000);
      refresh();
    </script>
  </body>
</html>
