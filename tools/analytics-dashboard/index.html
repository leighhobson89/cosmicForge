<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cosmic Forge - Analytics Dashboard</title>
    <link rel="stylesheet" href="/tools/analytics-dashboard/styles.css" />
  </head>
  <body data-theme="terminal">
    <header>
      <h1>Cosmic Forge - Analytics Dashboard</h1>
      <div class="controls">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="terminal" selected>Terminal</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="frosty">Frosty</option>
          <option value="summer">Summer</option>
          <option value="forest">Forest</option>
        </select>
        <label for="days">Range</label>
        <select id="days">
          <option value="1">Last 1 day</option>
          <option value="3">Last 3 days</option>
          <option value="7" selected>Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button id="refresh">Refresh</button>
        <span id="status" class="muted"></span>
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Summary</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Events</div><div class="value" id="kpiEvents">-</div></div>
          <div class="kpi"><div class="label">Unique Sessions</div><div class="value" id="kpiSessions">-</div></div>
          <div class="kpi"><div class="label">Unique Clients</div><div class="value" id="kpiClients">-</div></div>
          <div class="kpi"><div class="label">Miaplacidus Reached</div><div class="value" id="kpiMiaplacidus">-</div></div>
          <div class="kpi"><div class="label">Black Hole Discovered (Clients)</div><div class="value" id="kpiBlackHoleDiscovered">-</div></div>
          <div class="kpi"><div class="label">Black Hole Researched (Unique Clients)</div><div class="value" id="kpiBlackHoleResearched">-</div></div>
          <div class="kpi"><div class="label">Legendary Asteroids (Total)</div><div class="value" id="kpiLegendaryAsteroidsTotal">-</div></div>
          <div class="kpi"><div class="label">Legendary Asteroids (Unique Clients)</div><div class="value" id="kpiLegendaryAsteroidsUnique">-</div></div>
        </div>
        <div style="margin-top:14px">
          <h2>Pioneer Playtime (Active)</h2>
          <table>
            <thead><tr><th>Pioneer</th><th>Total Active Time</th></tr></thead>
            <tbody id="pioneerPlaytime"></tbody>
          </table>
        </div>
        <div style="margin-top:10px" class="muted">
          <span class="mono" id="meta"></span>
        </div>
      </div>

      <div class="grid">
        <div class="card span-6">
          <h2>Top Views (ui_view)</h2>
          <table>
            <thead><tr><th>View</th><th>Count</th></tr></thead>
            <tbody id="topViews"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Time Spent (ui_view_duration)</h2>
          <table>
            <thead><tr><th>View</th><th>Total Time</th></tr></thead>
            <tbody id="topDurations"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Top Achievements (achievement_granted)</h2>
          <table>
            <thead><tr><th>Achievement</th><th>Count</th></tr></thead>
            <tbody id="topAchievements"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Star System Activity</h2>
          <table>
            <thead><tr><th>Star System</th><th>Count</th></tr></thead>
            <tbody id="starSystems"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Theme Selections (Total)</h2>
          <table>
            <thead><tr><th>Theme</th><th>Selections</th></tr></thead>
            <tbody id="themeSelections"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Onboarding</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="onboarding"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Rocket Parts Built</h2>
          <table>
            <thead><tr><th>Rocket</th><th>Parts Built</th></tr></thead>
            <tbody id="rocketPartsBuilt"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Space Actions</h2>
          <table>
            <thead><tr><th>Action</th><th>Count</th></tr></thead>
            <tbody id="spaceActions"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Diplomacy Choices</h2>
          <table>
            <thead><tr><th>Choice</th><th>Count</th></tr></thead>
            <tbody id="diplomacyChoices"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Settings Usage (Unique Clients from Snapshots)</h2>
          <table>
            <thead><tr><th>Setting:State</th><th>Clients</th></tr></thead>
            <tbody id="settingsUsage"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Triggered Events</h2>
          <table>
            <thead><tr><th>Event</th><th>Triggered</th></tr></thead>
            <tbody id="triggeredEvents"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Philosophy Picks (Unique Clients)</h2>
          <table>
            <thead><tr><th>Philosophy</th><th>Clients</th></tr></thead>
            <tbody id="philosophyPicks"></tbody>
          </table>
        </div>

        <div class="card span-6">
          <h2>Best Selling Ascendency Perks</h2>
          <table>
            <thead><tr><th>Perk</th><th>Purchases</th></tr></thead>
            <tbody id="ascendencyPerks"></tbody>
          </table>
        </div>

        <div class="card span-12">
          <h2>Most Researched Philosophy Repeatables</h2>
          <table>
            <thead><tr><th>Philosophy:Tech</th><th>Research Count</th></tr></thead>
            <tbody id="philosophyRepeatables"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script type="module">
      const $ = (id) => document.getElementById(id);

      const AUTO_REFRESH_MS = 10_000;
      let refreshTimer = null;
      let loading = false;
      let currentAbortController = null;

      function applyTheme(theme) {
        if (!theme) return;
        document.body.setAttribute('data-theme', theme);
        try {
          localStorage.setItem('analytics_dashboard_theme', theme);
        } catch {
          // ignore
        }
      }

      function loadSavedTheme() {
        let saved = null;
        try {
          saved = localStorage.getItem('analytics_dashboard_theme');
        } catch {
          saved = null;
        }
        const theme = saved || 'terminal';
        const sel = $('theme');
        if (sel) sel.value = theme;
        applyTheme(theme);
      }

      function fmtInt(n) {
        return (typeof n === 'number') ? n.toLocaleString() : '-';
      }

      function fmtDuration(ms) {
        if (typeof ms !== 'number') return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const s = totalSeconds % 60;
        const totalMinutes = Math.floor(totalSeconds / 60);
        const m = totalMinutes % 60;
        const h = Math.floor(totalMinutes / 60);
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }

      function renderRows(tbodyId, rows, formatter = (v) => v) {
        const tbody = $(tbodyId);
        tbody.innerHTML = '';
        for (const r of rows || []) {
          const tr = document.createElement('tr');
          const tdKey = document.createElement('td');
          tdKey.textContent = r.key;
          tdKey.className = 'mono';
          const tdVal = document.createElement('td');
          tdVal.textContent = formatter(r.value);
          tr.appendChild(tdKey);
          tr.appendChild(tdVal);
          tbody.appendChild(tr);
        }
      }

      async function load() {
        if (loading) return;
        loading = true;
        const days = Number.parseInt($('days').value, 10);
        $('status').textContent = 'Loading...';

        try {
          if (currentAbortController) currentAbortController.abort();
          currentAbortController = new AbortController();
          const requestedLimit = 50000;
          const res = await fetch(`/api/report?days=${days}&limit=${requestedLimit}`, { signal: currentAbortController.signal });
          const json = await res.json();
          if (!res.ok) {
            throw new Error(json?.error || 'Request failed');
          }

          const { report, since, limit, fetched, pages } = json;

          $('kpiEvents').textContent = fmtInt(report.total_events);
          $('kpiSessions').textContent = fmtInt(report.unique_sessions);
          $('kpiClients').textContent = fmtInt(report.unique_clients);
          $('kpiMiaplacidus').textContent = fmtInt(report.miaplacidus_reached_count);
          $('kpiBlackHoleDiscovered').textContent = fmtInt(report.black_hole_discovered_unique_clients);
          $('kpiBlackHoleResearched').textContent = fmtInt(report.black_hole_researched_unique_clients);

          $('kpiLegendaryAsteroidsTotal').textContent = fmtInt(report.legendary_asteroid_discoveries);
          $('kpiLegendaryAsteroidsUnique').textContent = fmtInt(report.legendary_asteroid_unique_clients);

          $('meta').textContent = `since=${since} limit=${limit} fetched=${fetched ?? '-'} pages=${pages ?? '-'}`;

          renderRows('topViews', report.top_views, fmtInt);
          renderRows('topDurations', report.top_view_durations, fmtDuration);
          renderRows('topAchievements', report.top_achievements, fmtInt);
          renderRows('starSystems', report.star_system_activity, fmtInt);

          renderRows('pioneerPlaytime', report.pioneer_playtime, fmtDuration);

          renderRows('philosophyPicks', report.philosophy_selected_unique_clients, fmtInt);
          renderRows('ascendencyPerks', report.ascendency_perk_purchases, fmtInt);
          renderRows('philosophyRepeatables', report.philosophy_repeatables_researched, fmtInt);

          renderRows('themeSelections', report.theme_selected_counts, fmtInt);
          renderRows('settingsUsage', report.settings_snapshot_unique_clients_complete, fmtInt);

          renderRows('spaceActions', [
            { key: 'Starship launched', value: report.starship_launched },
            { key: 'Settle system', value: report.settle_system },
          ], fmtInt);

          renderRows('diplomacyChoices', report.diplomacy_choice_counts, fmtInt);
          renderRows('triggeredEvents', report.random_event_triggered_counts, fmtInt);

          renderRows('onboarding', [
            { key: 'Enter onboarding (YES)', value: report.onboarding_prompt_yes },
            { key: 'Decline onboarding (NO)', value: report.onboarding_prompt_no },
            { key: 'Exit onboarding', value: report.onboarding_exit },
          ], fmtInt);

          renderRows('rocketPartsBuilt', report.rocket_part_build_counts, fmtInt);

          $('status').textContent = 'OK';
        } catch (err) {
          if (err?.name === 'AbortError') {
            $('status').textContent = 'Loading...';
          } else {
            $('status').textContent = `Error: ${String(err?.message || err)}`;
          }
        } finally {
          loading = false;
        }
      }

      function startAutoRefresh() {
        stopAutoRefresh();
        if (document.hidden) return;
        refreshTimer = window.setInterval(() => {
          if (document.hidden) return;
          void load();
        }, AUTO_REFRESH_MS);
      }

      function stopAutoRefresh() {
        if (refreshTimer) {
          window.clearInterval(refreshTimer);
          refreshTimer = null;
        }
      }

      $('refresh').addEventListener('click', load);
      $('days').addEventListener('change', load);
      $('theme').addEventListener('change', (e) => {
        applyTheme(e.target.value);
      });

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopAutoRefresh();
          if (currentAbortController) currentAbortController.abort();
        } else {
          void load();
          startAutoRefresh();
        }
      });

      loadSavedTheme();
      load();
      startAutoRefresh();
    </script>
  </body>
</html>
